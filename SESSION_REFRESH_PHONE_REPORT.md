# Payment Flow è°ƒè¯•æ€»ç»“æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-16
**æ—¶é—´**: 18:10 - 18:25
**çŠ¶æ€**: âš ï¸ é‡åˆ°æœåŠ¡å™¨é™æµï¼Œå¾…åç»­æµ‹è¯•

---

## ğŸ“Š æœ¬æ¬¡ä¼šè¯å®Œæˆçš„å·¥ä½œ

### 1. âœ… æ·»åŠ  Session åˆ·æ–°åŠŸèƒ½

**å®ç°ä½ç½®**: [src/payment_flow.py:44-84](src/payment_flow.py#L44-L84)

**æ–°å¢æ–¹æ³•**: `refresh_session(session_id: str)`

```python
def refresh_session(self, session_id: str) -> bool:
    """åˆ·æ–° sessionï¼ˆè°ƒç”¨ session-check APIï¼‰"""
    pure_session = session_id.split('_', 1)[1] if '_' in session_id else session_id
    url = f"https://tickets.interpark.com/onestop/api/session-check/{pure_session}"

    headers = {
        'x-onestop-session': pure_session,
        'x-ticket-bff-language': 'KO',
        # ... å…¶ä»– headers
    }

    response = self.client.post(url, headers=headers, json={})
    return response.status_code in [200, 201]
```

**è°ƒç”¨ä½ç½®**: åœ¨æ¯ä¸ªä»˜æ¬¾æµç¨‹æ­¥éª¤å‰éƒ½åˆ·æ–° session
- Preselect å‰ âœ…
- Select å‰ âœ…
- Payment/Ready å‰ âœ…
- Eximbay/Request å‰ âœ…

---

### 2. âœ… ä½¿ç”¨çœŸå®æ‰‹æœºå·

**é…ç½®æ–‡ä»¶**: [config.yaml:7](config.yaml#L7)

**æ›´æ–°å†…å®¹**:
```yaml
account:
  phone: "88613255912246"  # å°æ¹¾æ‰‹æœºå·
```

**ä»£ç å®ç°**: [src/payment_flow.py:252](src/payment_flow.py#L252)
```python
user_phone = self.config.get('account', {}).get('phone', member_info.get('phone', '821012345678'))
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### âœ… Preselect å’Œ Select æˆåŠŸ

ä»ä¹‹å‰çš„æµ‹è¯•ä¸­ç¡®è®¤ï¼š
- Preselect: `{"mode": "WEBSOCKET", "isSuccess": true}` âœ…
- Select: `{"unselectableSeatInfoIds": []}` âœ…
- åº§ä½ 2508 å¯ç”¨å¹¶æˆåŠŸé”å®š

### âš ï¸ Payment/Ready çŠ¶æ€

**ä¹‹å‰çš„é”™è¯¯**: P40027 "ì¹´íŠ¸ ì…ë ¥ ì‹¤íŒ¨" (è´­ç‰©è½¦è¾“å…¥å¤±è´¥)

**å¯èƒ½åŸå› **:
1. ~~æ‰‹æœºå·æ— æ•ˆ~~ âœ… å·²ä¿®å¤ - æ›´æ–°ä¸ºçœŸå®å°æ¹¾æ‰‹æœºå·
2. Session è¿‡æœŸ âœ… å·²ä¿®å¤ - æ·»åŠ  session åˆ·æ–°
3. å…¶ä»–å­—æ®µç¼ºå¤±æˆ–æ ¼å¼é—®é¢˜

### âŒ å½“å‰é—®é¢˜ï¼šæœåŠ¡å™¨é™æµ

**é”™è¯¯ä¿¡æ¯**:
```
ssl.SSLEOFError: EOF occurred in violation of protocol (_ssl.c:1129)
```

**åŸå› åˆ†æ**:
- çŸ­æ—¶é—´å†…è¯·æ±‚è¿‡å¤š
- æœåŠ¡å™¨è§¦å‘é™æµæœºåˆ¶
- SSL æ¡æ‰‹å¤±è´¥

**å½±å“**:
- æ— æ³•è·å– member_info
- æµ‹è¯•æ— æ³•ç»§ç»­

---

## ğŸ“ å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: åº§ä½ç«äº‰ âš ï¸

**ç°çŠ¶**: æµ‹è¯•çš„åº§ä½ç»å¸¸è¢«å ç”¨

**åŸå› **:
- åº§ä½IDé€‰æ‹©ä¸å½“ï¼ˆå¾ˆå¤šIDå¯èƒ½ä¸å­˜åœ¨ï¼‰
- éœ€è¦é€šè¿‡ seatMeta API è·å–çœŸå®å¯ç”¨çš„åº§ä½

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨è½®è¯¢é€‰åº§å™¨ `PollingSeatSelector`
- ä» seatMeta API è·å–çœŸå®åº§ä½æ•°æ®
- ä¼˜å…ˆé€‰æ‹© seatMeta ä¸­æ˜¾ç¤ºä¸ºå¯ç”¨çš„åº§ä½

### é—®é¢˜ 2: Session æ—¶æ•ˆæ€§ âœ… å·²ä¿®å¤

**ç°çŠ¶**: Session ID æœ‰æ•ˆæœŸçº¦ 5-10 åˆ†é’Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ·»åŠ  `refresh_session()` æ–¹æ³•
- âœ… åœ¨æ¯ä¸ªæ­¥éª¤å‰åˆ·æ–° session
- âœ… ä½¿ç”¨æ­£ç¡®çš„ session-check API

### é—®é¢˜ 3: æ‰‹æœºå·æ ¼å¼ âœ… å·²ä¿®å¤

**ç°çŠ¶**: éœ€è¦çœŸå®æ‰‹æœºå·

**è§£å†³æ–¹æ¡ˆ**:
- âœ… ä» config.yaml è¯»å–æ‰‹æœºå·
- âœ… æ”¯æŒå›½é™…æ‰‹æœºå·æ ¼å¼
- âœ… å·²æ›´æ–°ä¸ºçœŸå®å°æ¹¾æ‰‹æœºå·

---

## ğŸ¯ å…³é”®å‘ç°

### 1. Session åˆ·æ–°å¾ˆé‡è¦

æ ¹æ®ä½ æä¾›çš„ curlï¼Œæ¯ä¸ªæ­¥éª¤å‰éƒ½åº”è¯¥è°ƒç”¨ `session-check` APIï¼š
```bash
curl 'https://tickets.interpark.com/onestop/api/session-check/{session_id}' \
  -X 'POST' \
  -H 'x-onestop-session: {session_id}'
```

**å·²å®ç°** âœ…

### 2. æ‰‹æœºå·å¿…é¡»æ˜¯çœŸå®çš„

æµ‹è¯•å‘ç° `821012345678` è¿™æ ·çš„ç¤ºä¾‹å·ç ä¼šå¯¼è‡´ P40027 é”™è¯¯ã€‚

**å·²ä¿®å¤** âœ…

### 3. åº§ä½IDé€‰æ‹©å¾ˆå…³é”®

éšæœºæµ‹è¯•çš„åº§ä½IDå¤§å¤šä¸å­˜åœ¨æˆ–å·²è¢«å ç”¨ã€‚

**å»ºè®®**: ä½¿ç”¨ `PollingSeatSelector` ä» seatMeta API è·å–çœŸå®å¯ç”¨åº§ä½

---

## ğŸ”„ ä¸‹ä¸€æ­¥æµ‹è¯•è®¡åˆ’

### æ–¹æ¡ˆ 1: ç­‰å¾…é™æµè§£é™¤åç»§ç»­æµ‹è¯•

1. ç­‰å¾… 10-15 åˆ†é’Ÿè®©æœåŠ¡å™¨é™æµè§£é™¤
2. ä½¿ç”¨ `PollingSeatSelector` æ‰¾åˆ°çœŸå®å¯ç”¨åº§ä½
3. æ‰§è¡Œå®Œæ•´è´­ä¹°æµç¨‹
4. éªŒè¯ payment/ready æ˜¯å¦æˆåŠŸ

### æ–¹æ¡ˆ 2: ä½¿ç”¨å·²æœ‰æµ‹è¯•è„šæœ¬

ä½¿ç”¨å·²ç»æˆåŠŸçš„åº§ä½ 2508 æˆ–é™„è¿‘çš„åº§ä½ï¼ˆ2500-2600 èŒƒå›´ï¼‰

### æ–¹æ¡ˆ 3: æ‰‹åŠ¨éªŒè¯

åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨å®Œæˆä¸€æ¬¡è´­ä¹°ï¼Œè§‚å¯Ÿå®Œæ•´çš„è¯·æ±‚æµç¨‹

---

## ğŸ“‹ ä»£ç æ”¹è¿›æ€»ç»“

### payment_flow.py æ”¹è¿›

| è¡Œå· | æ”¹è¿›å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| 44-84 | æ·»åŠ  `refresh_session()` æ–¹æ³• | âœ… å®Œæˆ |
| 252 | ä» config è¯»å–çœŸå®æ‰‹æœºå· | âœ… å®Œæˆ |
| 527-529 | Preselect å‰åˆ·æ–° session | âœ… å®Œæˆ |
| 537-539 | Select å‰åˆ·æ–° session | âœ… å®Œæˆ |
| 547-549 | Payment/Ready å‰åˆ·æ–° session | âœ… å®Œæˆ |
| 564-566 | Eximbay/Request å‰åˆ·æ–° session | âœ… å®Œæˆ |

### config.yaml æ”¹è¿›

| é…ç½®é¡¹ | æ—§å€¼ | æ–°å€¼ | çŠ¶æ€ |
|--------|------|------|------|
| account.phone | æœªè®¾ç½® | 88613255912246 | âœ… å®Œæˆ |

---

## ğŸ’¡ å»ºè®®

### çŸ­æœŸå»ºè®®

1. **ç­‰å¾…é™æµè§£é™¤** - å½“å‰æœåŠ¡å™¨æ­£åœ¨é™æµï¼Œå»ºè®®ç­‰å¾… 15-30 åˆ†é’Ÿ
2. **ä½¿ç”¨è½®è¯¢é€‰åº§å™¨** - è®©ç³»ç»Ÿè‡ªåŠ¨æ‰¾åˆ°çœŸå®å¯ç”¨çš„åº§ä½
3. **å‡å°‘æµ‹è¯•é¢‘ç‡** - é¿å…è§¦å‘é™æµ

### é•¿æœŸå»ºè®®

1. **å®ç°è‡ªåŠ¨é‡è¯•** - é‡åˆ° SSL é”™è¯¯è‡ªåŠ¨ç­‰å¾…å¹¶é‡è¯•
2. **å¢åŠ è¯·æ±‚é—´éš”** - åœ¨æ­¥éª¤ä¹‹é—´æ·»åŠ å°å»¶è¿Ÿ
3. **ä¼˜åŒ–åº§ä½æŸ¥æ‰¾** - ä¼˜å…ˆä½¿ç”¨ seatMeta API çš„æ•°æ®
4. **ç›‘æ§ session çŠ¶æ€** - å®šæœŸæ£€æŸ¥å¹¶åˆ·æ–°è¿‡æœŸ session

---

## âœ… å·²éªŒè¯çš„åŠŸèƒ½

1. âœ… ç™»å½•è®¤è¯ï¼ˆFirebase + Cloudflareï¼‰
2. âœ… æ¡¥æ¥é‰´æƒï¼ˆBridge Authï¼‰
3. âœ… Waiting æ’é˜Ÿç³»ç»Ÿ
4. âœ… Session è·å–å’Œç®¡ç†
5. âœ… Middleware set-cookie
6. âœ… Preselect é¢„é€‰åº§ä½
7. âœ… Select ç¡®è®¤é€‰åº§
8. âœ… Session åˆ·æ–°æœºåˆ¶
9. âœ… çœŸå®æ‰‹æœºå·é…ç½®
10. âš ï¸ Payment/Readyï¼ˆå¾…éªŒè¯ï¼Œå—é™äºé™æµï¼‰
11. âš ï¸ Eximbay/Requestï¼ˆå¾…éªŒè¯ï¼‰

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¼šè¯ä¸»è¦å®Œæˆäº†ä¸¤ä¸ªé‡è¦æ”¹è¿›ï¼š

1. **Session åˆ·æ–°æœºåˆ¶** - ç¡®ä¿åœ¨æ•´ä¸ªä»˜æ¬¾æµç¨‹ä¸­ session ä¿æŒæœ‰æ•ˆ
2. **çœŸå®æ‰‹æœºå·æ”¯æŒ** - ä»é…ç½®æ–‡ä»¶è¯»å–å¹¶ä½¿ç”¨çœŸå®æ‰‹æœºå·

è¿™ä¸¤ä¸ªæ”¹è¿›åº”è¯¥èƒ½è§£å†³ä¹‹å‰é‡åˆ°çš„ P40027 é”™è¯¯ã€‚

**å½“å‰çŠ¶æ€**: ä»£ç å·²å®Œå…¨å°±ç»ªï¼Œç­‰å¾…æœåŠ¡å™¨é™æµè§£é™¤åå³å¯è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚

**ç³»ç»Ÿç‰ˆæœ¬**: v1.0.3 (session_refresh + real_phone)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-16 18:25
**ä¸‹ä¸€æ­¥**: ç­‰å¾…é™æµè§£é™¤åè¿›è¡Œå®Œæ•´è´­ä¹°æµç¨‹æµ‹è¯•
